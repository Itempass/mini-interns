# Separate Models Per Agent and Trigger

**Date:** 2025.07.02  
**Goal:** Allow each agent and trigger to have its own OpenRouter model setting instead of using a single global model.

## Overview

### Current System
The system currently uses a single global `OPENROUTER_MODEL` setting stored in Redis that is shared by:
- **Agent execution** (`agent/internals/runner.py`) - when agents process tasks and make LLM calls
- **Trigger evaluation** (`triggers/main.py`) - when evaluating if incoming emails should trigger agents

This means all agents and all triggers use the same LLM model, which limits flexibility.

### Desired System
We want to change this so that:
- **Each agent** has its own `model` field and uses that model for execution
- **Each trigger** has its own `model` field and uses that model for evaluation
- **No global setting** - remove the shared `OPENROUTER_MODEL` completely
- **Default model** - use `"google/gemini-2.5-flash-preview-05-20:thinking"` for all new agents/triggers

### Benefits
- Different agents can use different models optimized for their specific tasks
- Trigger evaluation can use a fast/cheap model while agent execution uses a more capable one
- More granular control over model costs and performance per workflow

## Implementation Steps

### 1. âœ… Update Data Models
- âœ… Add `model: str` field to `AgentModel` in `agent/models.py`
- âœ… Add `model: str` field to `TriggerModel` in `agent/models.py`
- âœ… Set default value: `"google/gemini-2.5-flash-preview-05-20:thinking"`

### 2. âœ… Update Database Schema & Migration
- âœ… Add `model` column to `agents` table in `agent/schema.sql`
- âœ… Add `model` column to `triggers` table in `agent/schema.sql` 
- âœ… Add migration logic to `scripts/init_db.py`:
  - âœ… Use existing `add_column_if_not_exists()` function (already checks if migration was done)
  - âœ… Add `model` column and update existing records with default value
  - âœ… Migration is idempotent - safe to run on every startup
- âœ… Update database functions in `agent/internals/database.py` to handle new fields

### 3. âœ… Update Backend Logic
- âœ… Modify `agent/internals/runner.py` line 143: use `agent_model.model` instead of `app_settings.OPENROUTER_MODEL`
- âœ… Modify `triggers/main.py` line 100: use `trigger.model` instead of `app_settings.OPENROUTER_MODEL`

### 4. âœ… Update Frontend
- âœ… Add model input field to `frontend/components/AgentSettings.tsx` (agent editing UI on main page)  
- âœ… Add model input field for trigger settings within agent configuration
- âœ… Remove global "OpenRouter Model" field from `frontend/app/settings/page.tsx`
- âœ… Update main page (`frontend/app/page.tsx`) to handle new model fields

### 5. âœ… Clean Up Global Setting
- âœ… Remove `OPENROUTER_MODEL` from `AppSettings` in `shared/app_settings.py`
- âœ… Remove `OPENROUTER_MODEL` from Redis keys in `shared/redis/keys.py`
- âœ… Remove "OpenRouter Model" input field from `frontend/app/settings/page.tsx`
- âœ… Remove from API endpoints in `api/endpoints/app_settings.py`

### 6. âœ… Update API Types
- âœ… Add `model` field to agent/trigger API models
- âœ… Update frontend TypeScript interfaces

## Files to Modify

**Backend:**
- âœ… `agent/models.py`
- âœ… `agent/schema.sql`
- âœ… `scripts/init_db.py` (add migration logic)
- âœ… `agent/internals/database.py`
- âœ… `agent/internals/runner.py`
- âœ… `triggers/main.py`
- âœ… `shared/app_settings.py`
- âœ… `shared/redis/keys.py`
- âœ… `api/endpoints/app_settings.py`
- âœ… `api/types/api_models/agent.py`
- âœ… `api/types/api_models/single_agent.py`

**Frontend:**
- âœ… `frontend/services/api.ts` (update TypeScript interfaces)
- âœ… `frontend/app/page.tsx` (main agent management page)
- âœ… `frontend/components/AgentSettings.tsx` (add model input fields)
- âœ… `frontend/app/settings/page.tsx` (remove global OpenRouter model field)

## Default Model
Use `"google/gemini-2.5-flash-preview-05-20:thinking"` as the default for all new agents and triggers.

## Testing
- ðŸ”² Verify agents use their own model setting
- âœ… Verify triggers use their own model setting (test file updated and working)
- ðŸ”² Test agent/trigger creation with default model
- ðŸ”² Ensure existing functionality remains intact

## Status: âœ… COMPLETE
The implementation is now fully complete! Both backend and frontend changes have been implemented.

## Additional Fixes Completed
- âœ… Updated test file `triggers/tests/trigger_condition_test.py` to use new trigger model structure
- âœ… Fixed function signature changes in trigger condition checking
- âœ… Updated all API endpoints to handle model fields properly (create, import, export, update)
- âœ… Added proper default handling using temporary Pydantic models instead of hardcoded defaults 